{% extends 'base.html.twig' %}

{% block title %}Mon panier - Marché du Web{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/panier/index.style.css') }}">
{% endblock %}


{% block body %}
    <div id="loader"></div>

    {% if editions is not empty %}
        <div class="alert alert-info flash-custom">
            Le stock est insuffisant pour certains articles de votre panier.<br>
            Les quantités pour ces articles ont été modifiées.
        </div>
    {% endif %}

    {% if suppressions is not empty %}
        <div class="alert alert-warning flash-custom">
            Les produits suivants ne sont plus disponibles et ont étés retirés de votre panier :<br>
            {% for nom_produit in suppressions %}
                {{ nom_produit }}
                {% if not loop.last %},&nbsp;{% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {# {% for message in app.flashes("panier vide") %}
        <div class="alert alert-danger" id="msg-panier-vide">
            {{ message }}
        </div>
    {% endfor %} #}

    {# remplacer par un flashbag ? (plus court / simple) #}
    {# {% if modifications is not same as ([]) %}
        <div class="modal" tabindex="-1" id="modale-modifications">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Produits indisponibles</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <p>Les produits suivants de votre panier ne sont plus disponibles dans les quantites desirées. Votre panier a été modifié en consequence</p>

                        <div class="container">
                            <table class="table" id="table-modale">
                                <thead class="thead-dark" style="border: 0">
                                    <tr>
                                        <th scope="col col-modale" colspan="2" style="border: 0">
                                            Produit(s) concerné(s)
                                        </th>

                                        <th scope="col col-modale" style="border: 0">
                                            Nouvelle quantité
                                        </th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for infos in modifications %}
                                        {% set produit_actuel = infos["produit"] %}
                                        {% set images = produit_actuel.getImages() %}
                                        <tr>
                                            <td class="align-middle">
                                                <img src="{{ asset('images/produits/') ~ images[0].getImage() }}" class="card-img-top image-modale" alt="image " ~ produit_actuel.getNom()>
                                            </td>

                                            <td class="align-middle">
                                                {{ produit_actuel.getNom() }}
                                            </td>

                                            <td class="align-middle">
                                                {% if infos.difference is not defined %}
                                                    {{ infos["quantite"] }}
                                                {% else %}
                                                    {{ infos["quantite"] }} sont immédiatement disponibles,
                                                    {{ infos["difference"] }} necessitent un délai supplémentaire pour etre livrés
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %} #}

    {# <button class="btn btn-warning" id="test">vidange</button> #}

    <div class="container-fluid" id="containeur-principal">
        <h1>Mon panier</h1><hr>
        {% if panier.getProduits()|length > 0 %}
            <div id="affichage-sm">
                {% for panier_produit in panier.getProduits() %}
                    {% set produit = panier_produit.getProduit() %}
                    {% if loop.index is divisible by(2) %}
                        {% set fond = "fond-gris" %}
                    {% else %}
                        {% set fond = "" %}
                    {% endif %}
                    <div class="row" id="rang_reduit_{{ produit.id }}">
                        <div class="col-12 case-centree {{ fond }}">
                            <span class="span-poubelle-reduite">
                                <i class="fas fa-trash-alt poubelle-reduite" data-id="{{ produit.id }}" data-quantite="{{ panier_produit.getQuantite() }}"></i>
                            </span>
                        </div>

                        <div class="col-12 case-reduite {{ fond }}">
                            <span>Produit:</span>
                            <span class="span-nom">
                                <a href="{{ path('vue_produit', {'nom_produit': produit.nom()}) }}" class="lien-article">
                                    {{ produit.getNom() }}</a>
                            </span>
                        </div>

                        <div class="col-12 case-reduite {{ fond }}">
                            <span>Prix:</span>
                            <span>
                                {% if produit.getTvaActive() %}
                                    {% set tva = produit.getTauxTva().getTaux() %}
                                {% else %}
                                    {% set tva = 0 %}
                                {% endif %}

                                {% if produit.getDateDebutPromo()|date('Y-m-d') <= "now"|date('Y-m-d') and produit.getDateFinPromo()|date('Y-m-d') >= "now"|date('Y-m-d') %}
                                    {% set prix = produit.getTarifPromo()/100 + (produit.getTarifPromo()/100 * tva/10000) %}
                                    {# {{ prix|format_currency('EUR') }} #}
                                    &euro;{{ prix|number_format(2, ',', ' ') }}
                                {% else %}
                                    {% set prix = produit.tarif/100 + (produit.tarif/100 * tva/10000) %}
                                    {# {{ prix|format_currency('EUR') }} #}
                                    &euro;{{ prix|number_format(2, ',', ' ') }}
                                {% endif %}
                            </span>
                        </div>

                        {% set quantite_panier = app.session.get('quantites_session') %}
                        {% if quantite_panier[produit.id] is defined %}
                            {% set quantite_panier = quantite_panier[produit.id] %}
                        {% else %}
                            {% set quantite_panier = 0 %}
                        {% endif %}
                        {# {% set indisponible = false %}

                        {% if produit.getCommandableSansStock() == false and (quantite_panier >= produit.getQuantiteStock() or produit.getQuantiteStock() == 0) %}
                            {% set indisponible = true %}
                        {% endif %} #}

                        <div class="col-12 case-reduite {{ fond }}">
                            <span>Quantité:</span>
                            <span class="span-quantite">
                                <input class="form-control quantite-reduite" id="quantite_reduite_{{ produit.id }}" data-cible="#quantite_article_{{ produit.id }}" type="number" step="1" min="1"

                                {# {% if indisponible == true %}
                                    disabled
                                {% endif %} #}

                                {% if produit.getCommandableSansStock() %}
                                    {# max="99" #}
                                    max="{{quantite_max_commande}}"
                                {% else %}
                                    max="{{ produit.getQuantiteStock() - quantite_panier }}"
                                {% endif %}

                                {# {% if indisponible %}
                                    value="0"
                                {% else %}
                                    value="{{ quantite_panier }}"
                                {% endif %} #}
                                value="{{ quantite_panier }}"
                                
                                oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" />
                            </span>
                        </div>

                        <div class="col-12 case-reduite {{ fond }}">
                            <span>Sous-total:</span>
                            <span>
                                <span id="prix_total_article_reduit_{{ produit.id }}">
                                    {# {{ (prix * panier_produit.getQuantite())|format_currency('EUR') }} #}
                                    &euro;{{ (prix * panier_produit.getQuantite())|number_format(2, ',', ' ') }}
                                </span>
                            </span>
                        </div>
                    </div>

                    {#  #}
                    {% if produit.getCommandableSansStock() and quantite_panier > produit.getQuantiteStock() %}
                        <div class="row message-quantite stock_{{ produit.id }}">
                            <div class="col-12">
                                {{ produit.getQuantiteStock() }} sont disponibles en stock<br>
                                {{ quantite_panier - produit.getQuantiteStock() }} seront livrés ultérieurement
                            </div>
                        </div>
                    {% elseif editions[produit.id] is defined %}
                        <div class="row message-quantite">
                            <div class="col-12">
                                quantité editée
                            </div>
                        </div>
                    {% endif %}
                    {#  #}
                {% endfor %}
            </div>

            <div id="affichage-md">
                <div class="row entete-tableau">
                    <div class="col-md-4 offset-md-2 col-4 offset-1">Produit</div>
                    <div class="col-2">Prix</div>
                    <div class="col-md-2 col-3">Quantité</div>
                    <div class="col-2">Sous-total</div>
                </div>

                {% for panier_produit in panier.getProduits() %}
                    {% set produit = panier_produit.getProduit() %}
                    <div class="row" id="ligne_article_{{ produit.id }}">
                        <div class="col-1 case-article">
                            <span class="span-poubelle">
                                <i class="fas fa-trash-alt poubelle" id="poubelle_{{ produit.id }}" data-id="{{ produit.id }}" data-quantite="{{ panier_produit.getQuantite() }}"></i>
                            </span>
                        </div>

                        <div class="col-1 case-article image">
                            {% set images = produit.getImages() %}
                            <img src="{{ asset('images/produits/') ~ images[0].getImage() }}" class="card-img-top image-produit" alt="image " ~ produit.getNom()>
                        </div>

                        <div class="col-4 case-article">
                            <a href="{{ path('vue_produit', {'nom_produit': produit.nom()}) }}" class="lien-article">
                                {{ produit.getNom() }}</a>
                        </div>

                        <div class="col-2 case-article" id="prix_unitaire_{{ produit.id }}">
                            {% if produit.getTvaActive() %}
                                {% set tva = produit.getTauxTva().getTaux() %}
                            {% else %}
                                {% set tva = 0 %}
                            {% endif %}

                            {% if produit.getDateDebutPromo()|date('Y-m-d') <= "now"|date('Y-m-d') and produit.getDateFinPromo()|date('Y-m-d') >= "now"|date('Y-m-d') %}
                                {% set prix = produit.getTarifPromo()/100 + (produit.getTarifPromo()/100 * tva/10000) %}
                                {# {{ prix|format_currency('EUR') }} #}
                                &euro;{{ prix|number_format(2, ',', ' ') }}
                            {% else %}
                                {% set prix = produit.tarif/100 + (produit.tarif/100 * tva/10000) %}
                                {# {{ prix|format_currency('EUR') }} #}
                                &euro;{{ prix|number_format(2, ',', ' ') }}
                            {% endif %}
                        </div>

                        
                        {% set quantite_panier = app.session.get('quantites_session') %}
                        {% if quantite_panier[produit.id] is defined %}
                            {% set quantite_panier = quantite_panier[produit.id] %}
                        {% else %}
                            {% set quantite_panier = 0 %}
                        {% endif %}
                        {# {% set indisponible = false %}

                        {% if produit.getCommandableSansStock() == false and (quantite_panier >= produit.getQuantiteStock() or produit.getQuantiteStock() == 0) %}
                            {% set indisponible = true %}
                        {% endif %} #}

                        <div class="col-md-2 col-3 case-article">
                        {# {% if editions[produit.id] is defined %}
                            <div class="col-md-2 col-3 case-article quantite-editee">
                        {% elseif produit.getCommandableSansStock() and quantite_panier > produit.getQuantiteStock() %}
                            <div class="col-md-2 col-3 case-article hors-stock">
                        {% else %}
                            <div class="col-md-2 col-3 case-article">
                        {% endif %} #}

                            <input class="form-control quantite" id="quantite_article_{{ produit.id }}" type="number" step="1" min="1"

                            {# {% if indisponible == true %}
                                disabled
                            {% endif %} #}

                            {% if produit.getCommandableSansStock() %}
                                {# max="99" #}
                                max="{{quantite_max_commande}}"
                            {% else %}
                                max="{{ produit.getQuantiteStock() - quantite_panier }}"
                            {% endif %}

                            {# {% if indisponible %}
                                value="0"
                            {% else %}
                                value="{{ quantite_panier }}"
                            {% endif %} #}
                            value="{{ quantite_panier }}"

                            oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" />

                            {# <div>{{ editions["{{produit.id}}"] }}</div> #}
                            {# {% if produit.id is same as 130 %}
                                <div>{{ editions[produit.id] }}</div>
                            {% endif %} #}


                            {# {% if editions[produit.id] is defined %}
                                <div class="message-quantite-editee">quantité editée</div>
                            {% elseif produit.getCommandableSansStock() and quantite_panier > produit.getQuantiteStock() %}
                                <div class="message-sans-stock">
                                    {{ produit.getQuantiteStock() }} sont disponibles en stock<br>
                                    {{ quantite_panier - produit.getQuantiteStock() }} seront livrés ultérieurement
                                </div>
                            {% endif %} #}


                            {# 
                            {% if produit.getCommandableSansStock() && quantite_panier > produit.getQuantiteStock() %}
                                changer couleur fond + msg tt n'est pas dispo
                                produit.getQuantiteStock() livrables de suite
                                produit.getQuantiteStock() - quantite_panier livres plus tard


                                editions[produit.id] n'est pas renseigne pr produit commandable sans stock
                             #}





                        </div>

                        <div class="col-2 case-article total">
                            <span id="prix_total_article_{{ produit.id }}">
                                {# {{ (prix * panier_produit.getQuantite())|format_currency('EUR') }} #}
                                &euro;{{ (prix * panier_produit.getQuantite())|number_format(2, ',', ' ') }}
                            </span>
                        </div>
                    </div>
                    
                    {#  #}
                    {% if produit.getCommandableSansStock() and quantite_panier > produit.getQuantiteStock() %}
                        <div class="row message-quantite stock_{{ produit.id }}">
                            <div class="col-12">
                                {{ produit.getQuantiteStock() }} sont disponibles en stock<br>
                                {{ quantite_panier - produit.getQuantiteStock() }} seront livrés ultérieurement
                            </div>
                        </div>
                    {% elseif editions[produit.id] is defined %}
                        <div class="row message-quantite">
                            <div class="col-12">
                                quantité editée
                            </div>
                        </div>
                    {% endif %}
                    {#  #}
                    
                    
                    <hr>
                {% endfor %}
            </div>

            <div class="row d-none" id='ligne-promo'>
                <div class="col-2">
                    <button class="btn" id="bouton-reset-promo">Annuler le code promo</button>
                </div>

                <div class="col-8" id='description-promo'>
                </div>

                <div class="col-2" id="valeur-promo">
                </div>
            </div>

            <div class="row" id="rang-code-promo">
                <div class="col-md-3 col-6">
                    <input type="text" class="form-control" id="input-code-promo" placeholder="Code promo">   
                </div>

                <div class="col-md-4 col-6 p-md-0 p-auto">
                    <button type="button" class="btn" id="bouton-code-promo">APPLIQUER LE CODE PROMO</button>
                </div>
            </div><hr>

            <div class="row">
                <div class="col-12">
                    <button class="btn" id="bouton-vide-panier">VIDER LE PANIER</button>
                </div>
            </div>

            <div class="row" id="rang-sous-total">
                <div class="col-md-6 offset-md-6 col-12">
                    <table class="table">
                        <tbody>
                            <tr>
                                <td colspan="2" class="entete-tableau">Total panier</td>
                            </tr>

                            <tr>
                                <td>Sous total HT</td>
                                {# <td>&euro;<span id="prix_ht">{{ (panier.getMontantHt()/100)|number_format(2, ',', ' ')  }}</span></td> #}
                                {# <td><span id="prix_ht">{{ (panier.getMontantHt()/100)|format_currency('EUR')  }}</span></td> #}

                                {# <td id="prix_ht">{{ (panier.getMontantHt()/100)|format_currency('EUR')  }}</td> #} {# ORIGINAL #}

                                {# <td id="prix_ht">{{ (panier.getMontantHt()/100)|format_currency('EUR', locale='fr')  }}</td> #} {# marche pas alors que viens de la doc #}

                                <td id="prix_ht">&euro;{{ (panier.getMontantHt()/100)|number_format(2, ',', ' ')  }}</td> {# a defaut de mieux :-/ #}

                                
                            </tr>

                            <tr>
                                <td>Expédition</td>
                                <td>Livraison gratuite</td>
                            </tr>

                            <tr>
                                <td>TVA</td>
                                {# <td>&euro;<span id="prix_tva">{{ (panier.getMontantTtc()/100 - panier.getMontantHt()/100)|number_format(2, ',', ' ')  }}</span></td> #}
                                {# <td><span id="prix_tva">{{ (panier.getMontantTtc()/100 - panier.getMontantHt()/100)|format_currency('EUR')  }}</span></td> #}

                                {# <td id="prix_tva">{{ (panier.getMontantTtc()/100 - panier.getMontantHt()/100)|format_currency('EUR')  }}</td> #}
                                <td id="prix_tva">&euro;{{ (panier.getMontantTtc()/100 - panier.getMontantHt()/100)|number_format(2, ',', ' ')  }}</td>
                            </tr>

                            <tr class="d-none" id="tr-total-promo">
                                <td>Code promo</td>
                                <td id="td-total-promo"></td>
                            </tr>

                            <tr>
                                <td>Sous total TTC</td>
                                {# <td>&euro;<span id="prix_ttc" data-prix="{{ panier.getMontantTtc()/100 }}">{{ (panier.getMontantTtc()/100)|number_format(2, ',', ' ')  }}</span></td> #}
                                {# <td><span id="prix_ttc" data-prix="{{ panier.getMontantTtc()/100 }}">{{ (panier.getMontantTtc()/100)|format_currency('EUR')  }}</span></td> #}
                                
                                {# <td id="prix_ttc" data-prix="{{ panier.getMontantTtc()/100 }}">{{ (panier.getMontantTtc()/100)|format_currency('EUR')  }}</td> #}
                                <td id="prix_ttc" data-prix="{{ panier.getMontantTtc()/100 }}">&euro;{{ (panier.getMontantTtc()/100)|number_format(2, ',', ' ')  }}</td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                {# @TODO route pas encore cree #}
                                <button class="btn btn-warning">VALIDER (provi)</button>
                                    {# <a href="{{ path('panier_paiement') }}" id="bouton-valide-commande" class="btn btn-danger">VALIDER LA COMMANDE</a> #}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        
        {% else %}
            <div class="row" id="ligne-panier-vide">
                <div class="col-12" id="case-panier-vide">
                    Votre panier est actuellement vide.
                </div>
            </div>
            <a href="{{ path('categories') }}" class="btn" id="bouton-retour-boutique">RETOUR A LA BOUTIQUE</a>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# <script>
        let test_app = {{quantite_max_commande}}
    </script> #}
    <script src="{{ asset('js/panier/index.script.js') }}"></script>
{% endblock %}

